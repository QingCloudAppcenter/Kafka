{{- $useSASL := getv "/env/ca_sasl" }}
{{- if eq $useSASL "true" }}
mkdir -p /ssl
chmod 777 /ssl
flush > /ssl/ca-cert << KAFKA_CA_CERT_EOF
{{ getv "/env/ca_cert"}}
KAFKA_CA_CERT_EOF
flush > /ssl/ca-key << KAFKA_CA_KEY_EOF
{{ getv "/env/ca_key"}}
KAFKA_CA_KEY_EOF
flush > /ssl/kafka.config << KAFKA_SASL_CONFIG_EOF
security.protocol=SSL
ssl.truststore.location=/ssl/kafka.client.truststore.jks
ssl.truststore.password={{ getv "/env/ca_password" }}
ssl.keystore.password={{ getv "/env/ca_password" }}
ssl.keystore.location=/ssl/kafka.client.keystore.jks
ssl.endpoint.identification.algorithm=
KAFKA_SASL_CONFIG_EOF
{{- end }}

{{- if eq $myRole "kafka" }}

flush > /opt/app/conf/kafka/server.properties << KAFKA_SERVER_PROPERTIES_EOF
# fixed params
broker.id={{ getv "/host/sid" }}
broker.rack={{ getv "/host/zone" (getv "/cluster/zone") }}
host.name={{ $myIp }}
log.dirs=${DATA_MOUNTS}/kafka/kafka-logs
log.flush.interval.messages=10000
log.flush.interval.ms=1000
log.retention.check.interval.ms=300000
port=9092
replica.fetch.max.bytes=1000000
{{- $clusterId := getv "/cluster/cluster_id" }}
{{- $zkHosts := getvs "/links/zk_service/hosts/*/ip" }}
zookeeper.connect={{ range $i, $ip := $zkHosts }}{{ if $i }},{{ end }}{{ $ip }}:{{ $zkPort }}{{ end }}/kafka/{{ $clusterId }}
zookeeper.connection.timeout.ms=6000
zookeeper.session.timeout.ms=6000

{{- $useSASL := getv "/env/ca_sasl" }}
{{- if eq $useSASL "true" }}
listeners=SSL://{{ $myIp }}:9092
ssl.endpoint.identification.algorithm=
ssl.keystore.location=/ssl/kafka.server.keystore.jks
ssl.keystore.password={{ getv "/env/ca_password"}}
ssl.key.password={{ getv "/env/ca_password"}}
ssl.truststore.location=/ssl/kafka.server.truststore.jks
ssl.truststore.password={{ getv "/env/ca_password"}}
ssl.client.auth=required
security.inter.broker.protocol=SSL
{{- end }}

# params input by user
{{- range gets "/env/*" | filter ".+" }}
{{- $key := base .Key }}
{{- if not (eq (index (split $key ".") 0) "kafka-manager")}}
{{- if not (eq (index (split $key "_") 0) "ca") }}
{{- if eq (index (split $key "_") 0) "advertised"}}
{{- if not (eq $useSASL "true")}}
{{replace $key "_" "." -1}}={{ .Value }}
{{- end }}
{{- else }}
{{ $key }}={{ .Value }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}

# monitor
external.kafka.statsd.dimension.enabled.meanRate=false
external.kafka.statsd.dimension.enabled.median=false
external.kafka.statsd.dimension.enabled.p99=false
external.kafka.statsd.dimension.enabled.rate15m=fasle
external.kafka.statsd.metrics.exclude_regex=(.*kafka\.cluster\..*)|(.*kafka\.log\.Log\.partition\..*)|(.*jvm.gc\..*)|(.*jvm\.fd_usage.*)|(.*jvm.daemon_threads\..*)|(.*jvm\.memory\.pool\..*)|(.*request\.ConsumerMetadata\..*)|(.*request\.ControlledShutdown\..*)|(.*request\.Heartbeat\..*)|(.*request\.JoinGroup\..*)|(.*request\.LeaderAndIsr\..*)|(.*request\.Metadata\..*)|(.*request\.OffsetFetch\..*)|(.*request\.Offsets\..*)|(.*request\.StopReplica\..*)|(.*request\.UpdateMetadata\..*)|(.*request\.OffsetCommit\..*)|(.*consumer\.FetchRequestAndResponseMetrics\..*)|(.*network\.RequestChannel\..*)|(.*OffsetManager\..*)|(.*FetcherStats\..*)|(.*BrokerTopicMetrics\.topic\..*)|(.*FetcherLagMetrics\.clientId\..*)|(.*DelayedFetchRequestMetrics\..*)|(.*networkProcessor\..*)|(.*FailedFetchRequestsPerSec.*)|(.*FailedProduceRequestsPerSec.*)|(.*KafkaController\.PreferredReplicaImbalanceCount.*)|(.*BytesRejectedPerSec.*)|(.*DelayedProducerRequestMetrics\..*)|(.*MinFetchRate.*)|(.*ExpiresPerSecond\..*)|(.*NumDelayedRequests.*)|(.*ControllerStats.*)|(.*FetchRequestPurgatory.*)|(.*KafkaRequestHandlerPool.*)|(.*ProducerRequestPurgatory.*)|(.*RequestQueueTimeMs.*)|(.*LocalTimeMs.*)|(.*RemoteTimeMs.*)|(.*ResponseSendTimeMs.*)|(.*NetworkProcessorAvgIdlePercent.*)|(.*kafka\.log\..*)|(.*kafka\.utils\..*)|(.*RequestMetrics\..*)|(.*kafka\.coordinator\..*)|(.*TotalFetchRequestsPerSec.*)|(.*TotalProduceRequestsPerSec.*)|(.*DelayedOperationPurgatory\..*)|(.*yammer-metrics-count)|(.*SessionExpireListener\..*)|(.*DelayedFetchMetrics\.*)
external.kafka.statsd.metrics.prefix=
external.kafka.statsd.port=8125
external.kafka.statsd.reporter.enabled=true
kafka.metrics.reporters=com.airbnb.kafka.KafkaStatsdMetricsReporter
KAFKA_SERVER_PROPERTIES_EOF

{{- end }}
