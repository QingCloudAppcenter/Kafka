{{- if eq $myRole "kafka" }}

flush  /opt/app/current/conf/kafka/server.properties << KAFKA_SERVER_PROPERTIES_EOF
# fixed params
broker.id={{ getv "/host/sid" }}
broker.rack={{ getv "/host/zone" (getv "/cluster/zone") }}
host.name={{ $myIp }}
log.dirs=/data/kafka/kafka-logs
log.flush.interval.messages=10000
log.flush.interval.ms=1000
log.retention.check.interval.ms=300000
port=9092
replica.fetch.max.bytes=1000000
{{- $clusterId := getv "/cluster/cluster_id" }}
{{- $zkHosts := getvs "/links/zk_service/hosts/*/ip" }}
zookeeper.connect={{ range $i, $ip := $zkHosts }}{{ if $i }},{{ end }}{{ $ip }}:{{ $zkPort }}{{ end }}/kafka/{{ $clusterId }}
zookeeper.connection.timeout.ms=6000
zookeeper.session.timeout.ms=6000

{{- with getv "/env/advertised.host.name" "" }}
advertised.port={{ getv "/env/advertised.port" }}
advertised.host.name="{{ . }}"
{{- end }}
auto.create.topics.enable={{ getv "/env/auto.create.topics.enable" }}
compression.type={{ getv "/env/compression.type" }}
default.replication.factor={{ getv "/env/default.replication.factor" }}
delete.topic.enable={{ getv "/env/delete.topic.enable" }}
group.max.session.timeout.ms={{ getv "/env/group.max.session.timeout.ms" }}
group.min.session.timeout.ms={{ getv "/env/group.min.session.timeout.ms" }}
log.cleaner.enable={{ getv "/env/log.cleaner.enable" }}
log.cleanup.policy={{ getv "/env/log.cleanup.policy" }}
log.retention.bytes={{ getv "/env/log.retention.bytes" }}
log.retention.hours={{ getv "/env/log.retention.hours" }}
log.roll.hours={{ getv "/env/log.roll.hours" }}
log.segment.bytes={{ getv "/env/log.segment.bytes" }}
log.segment.delete.delay.ms={{ getv "/env/log.segment.delete.delay.ms" }}
message.max.bytes={{ getv "/env/message.max.bytes" }}
num.io.threads={{ getv "/env/num.io.threads" }}
num.network.threads={{ getv "/env/num.network.threads" }}
num.partitions={{ getv "/env/num.partitions" }}
num.recovery.threads.per.data.dir={{ getv "/env/num.recovery.threads.per.data.dir" }}
num.replica.fetchers={{ getv "/env/num.replica.fetchers" }}
offsets.topic.replication.factor={{ getv "/env/offsets.topic.replication.factor" }}
queued.max.requests={{ getv "/env/queued.max.requests" }}
replica.lag.time.max.ms={{ getv "/env/replica.lag.time.max.ms" }}
socket.receive.buffer.bytes={{ getv "/env/socket.receive.buffer.bytes" }}
socket.send.buffer.bytes={{ getv "/env/socket.send.buffer.bytes" }}
unclean.leader.election.enable={{ getv "/env/unclean.leader.election.enable" }}

# monitor
external.kafka.statsd.dimension.enabled.meanRate=false
external.kafka.statsd.dimension.enabled.median=false
external.kafka.statsd.dimension.enabled.p99=false
external.kafka.statsd.dimension.enabled.rate15m=fasle
external.kafka.statsd.metrics.exclude_regex=(.*kafka\.cluster\..*)|(.*kafka\.log\.Log\.partition\..*)|(.*jvm.gc\..*)|(.*jvm\.fd_usage.*)|(.*jvm.daemon_threads\..*)|(.*jvm\.memory\.pool\..*)|(.*request\.ConsumerMetadata\..*)|(.*request\.ControlledShutdown\..*)|(.*request\.Heartbeat\..*)|(.*request\.JoinGroup\..*)|(.*request\.LeaderAndIsr\..*)|(.*request\.Metadata\..*)|(.*request\.OffsetFetch\..*)|(.*request\.Offsets\..*)|(.*request\.StopReplica\..*)|(.*request\.UpdateMetadata\..*)|(.*request\.OffsetCommit\..*)|(.*consumer\.FetchRequestAndResponseMetrics\..*)|(.*network\.RequestChannel\..*)|(.*OffsetManager\..*)|(.*FetcherStats\..*)|(.*BrokerTopicMetrics\.topic\..*)|(.*FetcherLagMetrics\.clientId\..*)|(.*DelayedFetchRequestMetrics\..*)|(.*networkProcessor\..*)|(.*FailedFetchRequestsPerSec.*)|(.*FailedProduceRequestsPerSec.*)|(.*KafkaController\.PreferredReplicaImbalanceCount.*)|(.*BytesRejectedPerSec.*)|(.*DelayedProducerRequestMetrics\..*)|(.*MinFetchRate.*)|(.*ExpiresPerSecond\..*)|(.*NumDelayedRequests.*)|(.*ControllerStats.*)|(.*FetchRequestPurgatory.*)|(.*KafkaRequestHandlerPool.*)|(.*ProducerRequestPurgatory.*)|(.*RequestQueueTimeMs.*)|(.*LocalTimeMs.*)|(.*RemoteTimeMs.*)|(.*ResponseSendTimeMs.*)|(.*NetworkProcessorAvgIdlePercent.*)|(.*kafka\.log\..*)|(.*kafka\.utils\..*)|(.*RequestMetrics\..*)|(.*kafka\.coordinator\..*)|(.*TotalFetchRequestsPerSec.*)|(.*TotalProduceRequestsPerSec.*)|(.*DelayedOperationPurgatory\..*)|(.*yammer-metrics-count)|(.*SessionExpireListener\..*)|(.*DelayedFetchMetrics\.*)
external.kafka.statsd.metrics.prefix=
external.kafka.statsd.port=8125
external.kafka.statsd.reporter.enabled=true
kafka.metrics.reporters=com.airbnb.kafka.KafkaStatsdMetricsReporter
queued.max.requests=500

{{ if $myEip }}
listener.security.protocol.map=INSIDE:PLAINTEXT,OUTSIDE:SSL
#security.inter.broker.protocol=INSIDE
inter.broker.listener.name=INSIDE
listeners=INSIDE://:9092,OUTSIDE://:9093
advertised.listeners=OUTSIDE://{{ $myEip }}:9093,INSIDE://{{ $myIp }}:9092
#enable.ssl.certificate.verification=false
ssl.endpoint.identification.algorithm=
#ssl.client.auth=required
ssl.truststore.location=/data/kafka/ssl/{{ $myEip }}/kafka.server.truststore.jks
ssl.keystore.location=/data/kafka/ssl/{{ $myEip }}/kafka.server.keystore.jks
ssl.truststore.password=qingcloud
ssl.keystore.password=qingcloud
ssl.key.password=qingcloud
{{- end  }}

KAFKA_SERVER_PROPERTIES_EOF

{{- end }}
